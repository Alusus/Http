اشمل "مـتم/طـرفية.أسس"؛
اشمل "مـتم/نـص.أسس"؛
اشمل "مـتم/ذاكـرة.أسس"؛
اشمل "مـحا"؛
مـحا.اشمل_ملف("Alusus/Http"، "بـننف.أسس")؛

وحدة مثال_ويب_سوكت {
    استخدم مـتم؛

    دالة ابدأ() {
        عرف سياق: مؤشر[بـننف.سـياق] = بـننف.شغل_الخادم(معالج_طلب_بننف~مؤشر، "8080")؛
        
        بـننف.ضع_معالج_ويب_سوكت(
            سياق،
            "/websocket"،
            عند_اتصال_ويب_سوكت~مؤشر،
            عند_استعداد_ويب_سوكت~مؤشر،
            عند_بيانات_ويب_سوكت~مؤشر،
            عند_إغلاق_ويب_سوكت~مؤشر
        )؛

        طـرفية.اطبع("خادم مع دعم WebSocket يستمع على المنفذ 8080\ن")؛
        طـرفية.اطبع("HTTP: http://localhost:8080/\ن")؛
        طـرفية.اطبع("WebSocket: ws://localhost:8080/websocket\ن")؛
        طـرفية.اطبع("اضغط زر الإدخال لإغلاق الخادم.")؛
        طـرفية.أدخل_محرفا()؛
        بـننف.أوقف_الخادم(سياق)؛
        طـرفية.اطبع("أُغلق الخادم.\ناضغط زر الإدخال للخروج.")؛
        طـرفية.أدخل_محرفا()؛
    }

    دالة معالج_طلب_بننف(اتصال: مؤشر[بـننف.اتـصال]): صحيح {
        عرف معلومات_الطلب: مؤشر[بـننف.مـعلومات_الطلب] = بـننف.هات_معلومات_الطلب(اتصال)؛
        
        إذا نـص.متطابق(معلومات_الطلب~محتوى.المعرف_المحلي، "/") {
            عرف محتوى_الصفحة: مؤشر[محرف] = 
                "<!DOCTYPE html>\ن"
                "<html>\ن"
                "<head><title>اختبار WebSocket</title></head>\ن"
                "<body>\ن"
                "    <h1>صفحة اختبار WebSocket</h1>\ن"
                "    <div id=\"messages\"></div>\ن"
                "    <input type=\"text\" id=\"messageInput\" placeholder=\"اكتب رسالة...\">\ن"
                "    <button onclick=\"sendMessage()\">إرسال</button>\ن"
                "    <script>\ن"
                "        const ws = new WebSocket('ws://localhost:8080/websocket');\ن"
                "        const messages = document.getElementById('messages');\ن"
                "        const input = document.getElementById('messageInput');\ن"
                "\ن"
                "        ws.onopen = function(event) {\ن"
                "            addMessage('تم الاتصال بخادم WebSocket');\ن"
                "        };\ن"
                "\ن"
                "        ws.onmessage = function(event) {\ن"
                "            addMessage('الخادم: ' + event.data);\ن"
                "        };\ن"
                "\ن"
                "        ws.onclose = function(event) {\ن"
                "            addMessage('تم إغلاق الاتصال');\ن"
                "        };\ن"
                "\ن"
                "        function sendMessage() {\ن"
                "            const message = input.value;\ن"
                "            if (message) {\ن"
                "                ws.send(message);\ن"
                "                addMessage('أنت: ' + message);\ن"
                "                input.value = '';\ن"
                "            }\ن"
                "        }\ن"
                "\ن"
                "        function addMessage(message) {\ن"
                "            const div = document.createElement('div');\ن"
                "            div.textContent = message;\ن"
                "            messages.appendChild(div);\ن"
                "        }\ن"
                "\ن"
                "        input.addEventListener('keypress', function(e) {\ن"
                "            if (e.key === 'Enter') {\ن"
                "                sendMessage();\ن"
                "            }\ن"
                "        });\ن"
                "    </script>\ن"
                "</body>\ن"
                "</html>"؛
            
            بـننف.اطبع(اتصال، "HTTP/1.1 200 OK\r\n")؛
            بـننف.اطبع(اتصال، "Content-Type: text/html; charset=utf-8\r\n")؛
            بـننف.اطبع(اتصال، "Content-Length: %d\r\n\r\n"، نـص.هات_الطول(محتوى_الصفحة))؛
            بـننف.اطبع(اتصال، محتوى_الصفحة)؛
        } وإلا {
            بـننف.اطبع(اتصال، "HTTP/1.1 404 Not Found\r\n")؛
            بـننف.اطبع(اتصال، "Content-Type: text/plain; charset=utf-8\r\n")؛
            بـننف.اطبع(اتصال، "Content-Length: 14\r\n\r\n")؛
            بـننف.اطبع(اتصال، "غير موجود")؛
        }

        أرجع 1؛
    }

    دالة عند_اتصال_ويب_سوكت(اتصال: مؤشر[بـننف.اتـصال]، بيانات_المستخدم: مؤشر[فراغ]): صحيح {
        طـرفية.اطبع("عميل WebSocket اتصل\ن")؛
        أرجع 0؛
    }

    دالة عند_استعداد_ويب_سوكت(اتصال: مؤشر[بـننف.اتـصال]، بيانات_المستخدم: مؤشر[فراغ]): فراغ {
        طـرفية.اطبع("اتصال WebSocket جاهز\ن")؛
        بـننف.اكتب_ويب_سوكت_نصي(اتصال، "مرحباً بك في خادم WebSocket!"، 39)؛
    }

    دالة عند_بيانات_ويب_سوكت(اتصال: مؤشر[بـننف.اتـصال]، أجزاء: صحيح، بيانات: مؤشر[محرف]، طول_البيانات: صحيح، بيانات_المستخدم: مؤشر[فراغ]): صحيح {
        طـرفية.اطبع("تم استلام رسالة WebSocket: ")؛
        طـرفية.اطبع(بيانات، طول_البيانات)؛
        طـرفية.اطبع("\ن")؛
        
        عرف رد: مصفوفة[محرف، 256]؛
        نـص.عيّن(رد~مؤشر، "صدى: ")؛
        نـص.الحق(رد~مؤشر، بيانات، طول_البيانات)؛
        
        بـننف.اكتب_ويب_سوكت_نصي(اتصال، رد~مؤشر، نـص.هات_الطول(رد~مؤشر))؛
        أرجع 1؛
    }

    دالة عند_إغلاق_ويب_سوكت(اتصال: مؤشر[بـننف.اتـصال]، بيانات_المستخدم: مؤشر[فراغ]): فراغ {
        طـرفية.اطبع("عميل WebSocket انقطع\ن")؛
    }
}

مثال_ويب_سوكت.ابدأ()؛