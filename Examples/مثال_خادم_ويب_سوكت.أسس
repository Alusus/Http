اشمل "مـتم/طـرفية.أسس"؛
اشمل "مـتم/نـص.أسس"؛
اشمل "مـتم/ذاكـرة.أسس"؛
اشمل "مـحا"؛
مـحا.اشمل_ملف("Alusus/Http"، "بـننف.أسس")؛

وحدة مثال_ويب_سوكت {
    استخدم مـتم؛

    دالة ابدأ() {
        عرف سياق: مؤشر[بـننف.سـياق] = بـننف.شغل_الخادم(معالج_طلب_بننف~مؤشر، "8080")؛
        
        بـننف.حدد_معالج_ويب_سوكت(
            سياق،
            ‏"/websocket"،
            عند_اتصال_ويب_سوكت~مؤشر،
            عند_استعداد_ويب_سوكت~مؤشر،
            عند_بيانات_ويب_سوكت~مؤشر،
            عند_إغلاق_ويب_سوكت~مؤشر
        )؛

        طـرفية.اطبع("خادم مع دعم WebSocket يستمع على المنفذ 8080\ج")؛
        طـرفية.اطبع("HTTP: http://localhost:8080/\ج")؛
        طـرفية.اطبع("WebSocket: ws://localhost:8080/websocket\ج")؛
        طـرفية.اطبع("اضغط زر الإدخال لإغلاق الخادم.")؛
        طـرفية.أدخل_محرفا()؛
        بـننف.أوقف_الخادم(سياق)؛
        طـرفية.اطبع("أُغلق الخادم.\جاضغط زر الإدخال للخروج.")؛
        طـرفية.أدخل_محرفا()؛
    }

    دالة معالج_طلب_بننف(اتصال: مؤشر[بـننف.اتـصال]): صـحيح {
        عرف معلومات_الطلب: مؤشر[بـننف.مـعلومات_الطلب] = بـننف.هات_معلومات_الطلب(اتصال)؛
        
        إذا نـص.أمتطابق(معلومات_الطلب~محتوى.المعرف_المحلي، "/websocket") {
            أرجع 0؛
        }

        إذا نـص.أمتطابق(معلومات_الطلب~محتوى.المعرف_المحلي، "/") {
            عرف محتوى_الصفحة: مـؤشر_محارف =
                "<!DOCTYPE html>\n"
                "<html>\n"
                "<head><title>اختبار WebSocket</title></head>\n"
                "<body dir=rtl>\n"
                "    <h1>صفحة اختبار WebSocket</h1>\n"
                "    <div id=\"messages\"></div>\n"
                "    <input type=\"text\" id=\"messageInput\" placeholder=\"اكتب رسالة...\">\n"
                "    <button onclick=\"sendMessage()\">إرسال</button>\n"
                "    <script>\n"
                "        const ws = new WebSocket('ws://localhost:8080/websocket');\n"
                "        const messages = document.getElementById('messages');\n"
                "        const input = document.getElementById('messageInput');\n"
                "\n"
                "        ws.onopen = function(event) {\n"
                "            addMessage('تم الاتصال بخادم WebSocket');\n"
                "        };\n"
                "\n"
                "        ws.onmessage = function(event) {\n"
                "            addMessage('الخادم: ' + event.data);\n"
                "        };\n"
                "\n"
                "        ws.onclose = function(event) {\n"
                "            addMessage('تم إغلاق الاتصال');\n"
                "        };\n"
                "\n"
                "        function sendMessage() {\n"
                "            const message = input.value;\n"
                "            if (message) {\n"
                "                ws.send(message);\n"
                "                addMessage('أنت: ' + message);\n"
                "                input.value = '';\n"
                "            }\n"
                "        }\n"
                "\n"
                "        function addMessage(message) {\n"
                "            const div = document.createElement('div');\n"
                "            div.textContent = message;\n"
                "            messages.appendChild(div);\n"
                "        }\n"
                "\n"
                "        input.addEventListener('keypress', function(e) {\n"
                "            if (e.key === 'Enter') {\n"
                "                sendMessage();\n"
                "            }\n"
                "        });\n"
                "    </script>\n"
                "</body>\n"
                "</html>"؛
            
            بـننف.اطبع(اتصال، "HTTP/1.1 200 OK\r\n")؛
            بـننف.اطبع(اتصال، "Content-Type: text/html; charset=utf-8\r\n")؛
            بـننف.اطبع(اتصال، "Content-Length: %d\r\n\r\n"، نـص.هات_الطول(محتوى_الصفحة))؛
            بـننف.اطبع(اتصال، محتوى_الصفحة)؛
        } وإلا {
            بـننف.اطبع(اتصال، "HTTP/1.1 404 Not Found\r\n")؛
            بـننف.اطبع(اتصال، "Content-Type: text/plain; charset=utf-8\r\n")؛
            بـننف.اطبع(اتصال، "Content-Length: 14\r\n\r\n")؛
            بـننف.اطبع(اتصال، "غير موجود")؛
        }

        أرجع 1؛
    }

    دالة عند_اتصال_ويب_سوكت(اتصال: مؤشر[بـننف.اتـصال]، بيانات_المستخدم: مؤشر[فـراغ]): صـحيح {
        طـرفية.اطبع("عميل WebSocket اتصل\n")؛
        أرجع 0؛
    }

    دالة عند_استعداد_ويب_سوكت(اتصال: مؤشر[بـننف.اتـصال]، بيانات_المستخدم: مؤشر[فـراغ]): فـراغ {
        طـرفية.اطبع("اتصال WebSocket جاهز\n")؛
        بـننف.اكتب_نصا_في_ويب_سوكت(اتصال، "مرحباً بك في خادم WebSocket!")؛
    }

    دالة عند_بيانات_ويب_سوكت(
        اتصال: مؤشر[بـننف.اتـصال]،
        رمز_العملية: صـحيح،
        بيانات: مـؤشر_محارف،
        طول_البيانات: طـبيعي_متكيف،
        بيانات_المستخدم: مؤشر[فـراغ]
    ): صـحيح {
        إذا (رمز_العملية & 1) == 0 ارجع 1؛

        طـرفية.اطبع("تم استلام رسالة WebSocket: ")؛
        طـرفية.اطبع(بيانات، طول_البيانات)؛
        طـرفية.اطبع("\n")؛
        
        عرف رد: مصفوفة[مـحرف، 256]؛
        نـص.عيّن(رد~مؤشر، "صدى: ")؛
        نـص.سلسل(رد~مؤشر، بيانات، طول_البيانات)؛
        
        بـننف.اكتب_نصا_في_ويب_سوكت(اتصال، رد~مؤشر)؛
        أرجع 1؛
    }

    دالة عند_إغلاق_ويب_سوكت(اتصال: مؤشر[بـننف.اتـصال]، بيانات_المستخدم: مؤشر[فـراغ]): فـراغ {
        طـرفية.اطبع("عميل WebSocket انقطع\n")؛
    }
}

مثال_ويب_سوكت.ابدأ()؛